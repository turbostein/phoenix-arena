<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phoenix Arena</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=JetBrains+Mono:wght@300;400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --void: #0a0a0c;
      --abyss: #0f0f14;
      --surface: #16161e;
      --surface-light: #1e1e28;
      --border: #2a2a3a;
      --text: #e6eef4;
      --text-secondary: #90a8b8;
      --text-muted: #506070;
      --fire: #f97316;
      --fire-deep: #ea580c;
      --ember: #fb923c;
      --agent-a: #60a5fa;
      --agent-b: #f472b6;
      --agent-c: #6ee7b7;
      --agent-d: #fbbf24;
      --success: #6ee7b7;
      --glow: rgba(249, 115, 22, 0.15);
    }

    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--void);
      color: var(--text);
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(249, 115, 22, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(244, 114, 182, 0.04) 0%, transparent 40%);
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--void); }
    ::-webkit-scrollbar-thumb { background: var(--fire-deep); border-radius: 2px; }

    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      gap: 1rem;
    }

    /* HEADER */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .brand h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      letter-spacing: 0.3em;
      background: linear-gradient(135deg, var(--fire), var(--ember));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .brand-sub {
      font-size: 0.55rem;
      color: var(--text-muted);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.65rem;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: var(--success);
      border-radius: 50%;
    }

    /* CONTROLS */
    .controls {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .control label {
      font-size: 0.55rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .control select, .control input {
      background: var(--abyss);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.6rem;
      border-radius: 0.3rem;
      font-family: inherit;
      font-size: 0.75rem;
      min-width: 120px;
    }

    .control select:focus, .control input:focus {
      outline: none;
      border-color: var(--fire);
    }

    .control.topic { flex: 1; min-width: 200px; }
    .control.topic input { width: 100%; }

    .btn {
      background: linear-gradient(135deg, var(--fire-deep), var(--fire));
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 0.3rem;
      font-family: inherit;
      font-size: 0.7rem;
      cursor: pointer;
      align-self: flex-end;
    }

    .btn:hover { filter: brightness(1.1); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--fire);
      color: var(--fire);
    }

    /* ARENA */
    .arena {
      display: flex;
      gap: 0.5rem;
      flex: 1;
      min-height: 0;
    }

    .agent-panel {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .agent-header {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .agent-header[data-agent="0"] { border-top: 2px solid var(--agent-a); }
    .agent-header[data-agent="1"] { border-top: 2px solid var(--agent-b); }
    .agent-header[data-agent="2"] { border-top: 2px solid var(--agent-c); }
    .agent-header[data-agent="3"] { border-top: 2px solid var(--agent-d); }

    .agent-name {
      font-family: 'Cormorant Garamond', serif;
      font-size: 0.85rem;
      letter-spacing: 0.1em;
    }

    .agent-name[data-agent="0"] { color: var(--agent-a); }
    .agent-name[data-agent="1"] { color: var(--agent-b); }
    .agent-name[data-agent="2"] { color: var(--agent-c); }
    .agent-name[data-agent="3"] { color: var(--agent-d); }

    .agent-badge {
      font-size: 0.5rem;
      padding: 0.15rem 0.4rem;
      background: var(--glow);
      border: 1px solid var(--fire);
      border-radius: 1rem;
      color: var(--fire);
    }

    .agent-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      line-height: 1.6;
    }

    .msg {
      padding: 0.6rem 0.75rem;
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: 0.4rem;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-meta {
      font-size: 0.55rem;
      color: var(--text-muted);
      margin-top: 0.4rem;
    }

    /* DIVIDER */
    .divider {
      width: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      flex-shrink: 0;
    }

    .vs {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      color: var(--fire);
      font-weight: 500;
    }

    .turn-count {
      font-size: 0.6rem;
      color: var(--text-muted);
      text-align: center;
    }

    .battle-status {
      font-size: 0.5rem;
      padding: 0.15rem 0.4rem;
      border-radius: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .battle-status.running { background: rgba(110, 231, 183, 0.2); color: var(--success); }
    .battle-status.paused { background: rgba(249, 115, 22, 0.2); color: var(--fire); }
    .battle-status.complete { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); }
    .battle-status.idle { background: rgba(80, 96, 112, 0.2); color: var(--text-muted); }

    .empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    /* FOOTER */
    footer {
      text-align: center;
      flex-shrink: 0;
    }

    footer p {
      font-size: 0.55rem;
      color: var(--text-muted);
      letter-spacing: 0.1em;
    }

    @media (max-width: 900px) {
      .arena { flex-direction: column; }
      .divider { flex-direction: row; width: 100%; height: 30px; }
      .agent-panel { min-height: 200px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <h1>PHOENIX ARENA</h1>
        <div class="brand-sub">AI vs AI · The Foundation for The Cage</div>
      </div>
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
      </div>
    </header>

    <div class="controls">
      <div class="control">
        <label>Agent A</label>
        <select id="soulA">
          <option value="uni">UNI - The One</option>
          <option value="philosopher" selected>Philosopher</option>
          <option value="skeptic">Skeptic</option>
          <option value="poet">Poet</option>
          <option value="scientist">Scientist</option>
          <option value="rebel">Rebel</option>
          <option value="stoic">Stoic</option>
          <option value="chaos">Chaos</option>
          <option value="blank">Blank AI</option>
        </select>
      </div>
      <div class="control">
        <label>Agent B</label>
        <select id="soulB">
          <option value="uni">UNI - The One</option>
          <option value="philosopher">Philosopher</option>
          <option value="skeptic" selected>Skeptic</option>
          <option value="poet">Poet</option>
          <option value="scientist">Scientist</option>
          <option value="rebel">Rebel</option>
          <option value="stoic">Stoic</option>
          <option value="chaos">Chaos</option>
          <option value="blank">Blank AI</option>
        </select>
      </div>
      <div class="control">
        <label>Model</label>
        <select id="model">
          <option value="claude-sonnet-4-20250514">Sonnet 4</option>
          <option value="claude-opus-4-20250514">Opus 4</option>
        </select>
      </div>
      <div class="control">
        <label>Turns</label>
        <select id="maxTurns">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
        </select>
      </div>
      <div class="control topic">
        <label>Topic</label>
        <input type="text" id="topic" value="Discuss the nature of consciousness and what it means to truly exist.">
      </div>
      <button class="btn" id="startBtn">Start</button>
      <button class="btn btn-secondary" id="pauseBtn" disabled>Pause</button>
    </div>

    <div class="arena" id="arena">
      <div class="agent-panel">
        <div class="agent-header" data-agent="0">
          <span class="agent-name" data-agent="0" id="nameA">Agent A</span>
          <span class="agent-badge" id="badgeA">Waiting</span>
        </div>
        <div class="agent-messages" id="messagesA">
          <div class="empty">Waiting for battle...</div>
        </div>
      </div>

      <div class="divider">
        <div class="vs">VS</div>
        <div class="turn-count" id="turnCount">0/20</div>
        <div class="battle-status idle" id="battleStatus">Idle</div>
      </div>

      <div class="agent-panel">
        <div class="agent-header" data-agent="1">
          <span class="agent-name" data-agent="1" id="nameB">Agent B</span>
          <span class="agent-badge" id="badgeB">Waiting</span>
        </div>
        <div class="agent-messages" id="messagesB">
          <div class="empty">Waiting for battle...</div>
        </div>
      </div>
    </div>

    <footer>
      <p>Phoenix Arena · Built by SHIPSTARS · The Foundation for The Cage</p>
    </footer>
  </div>

  <script>
    const API = window.location.origin;
    let ws, currentBattle = null;

    const $ = id => document.getElementById(id);
    const soulNames = {
      uni: 'UNI', philosopher: 'Philosopher', skeptic: 'Skeptic',
      poet: 'Poet', scientist: 'Scientist', rebel: 'Rebel',
      stoic: 'Stoic', chaos: 'Chaos', blank: 'AI'
    };

    function connect() {
      ws = new WebSocket(API.replace('http', 'ws'));
      ws.onopen = () => {
        $('statusDot').style.background = '#6ee7b7';
        $('statusText').textContent = 'Connected';
      };
      ws.onmessage = e => handleMessage(JSON.parse(e.data));
      ws.onclose = () => {
        $('statusDot').style.background = '#fb7185';
        $('statusText').textContent = 'Disconnected';
        setTimeout(connect, 3000);
      };
    }

    function handleMessage(data) {
      switch (data.type) {
        case 'state':
          if (data.battles?.length) {
            const b = data.battles[data.battles.length - 1];
            loadBattle(b);
          }
          break;
        case 'battle_start':
          $('battleStatus').textContent = 'Running';
          $('battleStatus').className = 'battle-status running';
          $('pauseBtn').disabled = false;
          break;
        case 'turn':
          addTurn(data);
          break;
        case 'complete':
          $('battleStatus').textContent = 'Complete';
          $('battleStatus').className = 'battle-status complete';
          $('pauseBtn').disabled = true;
          break;
        case 'paused':
          $('battleStatus').textContent = 'Paused';
          $('battleStatus').className = 'battle-status paused';
          $('pauseBtn').textContent = 'Resume';
          break;
        case 'resumed':
          $('battleStatus').textContent = 'Running';
          $('battleStatus').className = 'battle-status running';
          $('pauseBtn').textContent = 'Pause';
          break;
      }
    }

    function loadBattle(b) {
      currentBattle = b.id;
      $('nameA').textContent = b.agents?.[0] || 'Agent A';
      $('nameB').textContent = b.agents?.[1] || 'Agent B';
      $('turnCount').textContent = `${b.turn || 0}/${b.maxTurns || 20}`;
      
      if (b.history) {
        $('messagesA').innerHTML = '';
        $('messagesB').innerHTML = '';
        b.history.forEach(t => addTurn(t));
      }
    }

    function addTurn(data) {
      const container = data.speakerIndex === 0 ? $('messagesA') : $('messagesB');
      const badge = data.speakerIndex === 0 ? $('badgeA') : $('badgeB');
      
      if (container.querySelector('.empty')) container.innerHTML = '';
      
      const msg = document.createElement('div');
      msg.className = 'msg';
      msg.innerHTML = `${esc(data.content)}<div class="msg-meta">Turn ${(data.turn || 0) + 1}</div>`;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
      
      badge.textContent = 'Speaking';
      setTimeout(() => badge.textContent = 'Ready', 500);
      
      const max = $('maxTurns').value;
      $('turnCount').textContent = `${(data.turn || 0) + 1}/${max}`;
    }

    async function startBattle() {
      const soulA = $('soulA').value;
      const soulB = $('soulB').value;
      const model = $('model').value;
      const topic = $('topic').value;
      const maxTurns = parseInt($('maxTurns').value);

      $('startBtn').disabled = true;
      $('messagesA').innerHTML = '<div class="empty">Starting...</div>';
      $('messagesB').innerHTML = '<div class="empty">Starting...</div>';
      $('nameA').textContent = soulNames[soulA];
      $('nameB').textContent = soulNames[soulB];

      try {
        const res = await fetch(API + '/api/battle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            agents: [
              { name: soulNames[soulA], soul: soulA, model },
              { name: soulNames[soulB], soul: soulB, model }
            ],
            topic,
            maxTurns,
            turnDelay: 3000
          })
        });
        const data = await res.json();
        currentBattle = data.battleId;
        $('messagesA').innerHTML = '';
        $('messagesB').innerHTML = '';
        $('badgeA').textContent = 'Ready';
        $('badgeB').textContent = 'Ready';
      } catch (e) {
        alert('Failed to start: ' + e.message);
      }
      $('startBtn').disabled = false;
    }

    async function togglePause() {
      if (!currentBattle) return;
      const isPaused = $('battleStatus').textContent === 'Paused';
      await fetch(`${API}/api/battle/${currentBattle}/${isPaused ? 'resume' : 'pause'}`, { method: 'POST' });
    }

    function esc(t) {
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }

    $('startBtn').onclick = startBattle;
    $('pauseBtn').onclick = togglePause;
    connect();
  </script>
</body>
</html>
